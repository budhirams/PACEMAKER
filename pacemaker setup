üü¢ Full 2-Node Pacemaker Cluster Setup with VMware fencing (A-Z)
üî∑ Prerequisites:

‡§¶‡•ã nodes:

cmpcprmq90 (Node 1)
cmpcprmq94 (Node 2)

VMware vCenter credentials (REST API enabled)

Root / sudo access ‡§¶‡•ã‡§®‡•ã‡§Ç nodes ‡§™‡§∞

Network connectivity ‡§¶‡•ã‡§®‡•ã‡§Ç nodes ‡§î‡§∞ vCenter ‡§ï‡•á ‡§¨‡•Ä‡§ö

Both nodes ‡§™‡§∞ hostname properly set ‡§π‡•ã (cmpcprmq90, cmpcprmq94) ‡§î‡§∞ /etc/hosts ‡§Ø‡§æ DNS ‡§Æ‡•á‡§Ç entries ‡§π‡•ã‡§Ç
Summary:
Step	Command/example
Edit hosts file	sudo vi /etc/hosts
Add lines	172.16.0.201 cmpcprmq90
172.16.0.202 cmpcprmq94
Save & exit	:wq
Test DNS resolution	ping cmpcprmq94





Step 1 ‚Äî Install required packages (‡§¶‡•ã‡§®‡•ã‡§Ç nodes):
sudo yum install -y pacemaker pcs fence-agents-all

Step 2 ‚Äî Enable and start pcsd service (‡§¶‡•ã‡§®‡•ã‡§Ç nodes):
sudo systemctl enable pcsd --now

Step 3 ‚Äî Set password for hacluster user (‡§¶‡•ã‡§®‡•ã‡§Ç nodes):
sudo passwd hacluster


(Ensure both nodes have same password for hacluster)

Step 4 ‚Äî Authenticate cluster nodes (from cmpcprmq90):
sudo pcs cluster auth cmpcprmq90 cmpcprmq94 -u hacluster -p <password>

Step 5 ‚Äî Setup cluster:
sudo pcs cluster setup --name mq_cluster cmpcprmq90 cmpcprmq94

Step 6 ‚Äî Start and enable cluster on both nodes:
sudo pcs cluster start --all
sudo pcs cluster enable --all

Step 7 ‚Äî Set quorum policy (important for 2 node cluster):
sudo pcs property set no-quorum-policy=freeze
freeze
Quorum ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ ‡§§‡•ã resource operations ‡§∞‡•ã‡§ï ‡§¶‡•á‡§ó‡§æ
Production ‡§Æ‡•á‡§Ç best practice


Step 8 ‚Äî Configure VMware fencing (STONITH)
Example command (replace with your vCenter info):



{ 
self
2Ô∏è‚É£ fence_vmware_rest ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?
‡§Ø‡•á ‡§è‡§ï fencing agent (plugin) ‡§π‡•à ‡§ú‡•ã VMware vSphere ‡§Ø‡§æ vCenter ‡§ï‡•á REST API ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á virtual machines ‡§ï‡•ã power off/on/reboot ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
‡§á‡§∏‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§§‡§¨ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡§¨ ‡§Ü‡§™‡§ï‡§æ cluster nodes VMware virtual machines ‡§Æ‡•á‡§Ç running ‡§π‡•ã‡§Ç‡•§
fence_vmware_rest agent VMware ‡§ï‡•á API ‡§ï‡•á ‡§ú‡§º‡§∞‡§ø‡§Ø‡•á VM ‡§ï‡•ã remotely ‡§¨‡§Ç‡§¶ ‡§Ø‡§æ restart ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
}




IP Address	Role
10.191.22.53	VMware vCenter / ESXi Host IP (fencing ‡§ï‡•á ‡§≤‡§ø‡§è)
10.191.145.144	Virtual IP (VIP) ‡§ú‡•ã cluster resource ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ç‡§≤‡•ã‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à




Virtual IP resource create ‡§ï‡§∞‡§§‡•á ‡§µ‡§ï‡•ç‡§§:

pcs resource create VirtualIP IPaddr2 ip=10.191.145.144 cidr_netmask=21 nic=ens192 op monitor interval=20s

VirtualIP ‚Üí resource name
IPaddr2 ‚Üí resource agent ‡§ú‡•ã VIP handle ‡§ï‡§∞‡§§‡§æ ‡§π‡•à                 ------------- vip means virtual ip
ip=10.191.145.144 ‚Üí ‡§µ‡§π IP ‡§ú‡•ã cluster ‡§Æ‡•á‡§Ç floating ‡§π‡•ã‡§ó‡•Ä
cidr_netmask=21 ‚Üí network mask
nic=ens192 ‚Üí network interface name
op monitor interval=20s ‚Üí 20 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç health check

VMware fencing resource create ‡§ï‡§∞‡§§‡•á ‡§µ‡§ï‡•ç‡§§:

pcs stonith create vmfence fence_vmware_rest \
ipaddr=10.191.22.53 \
username=cmpmq@sbi.co.in \
passwd='gfhfhhhhfh' \
ssl_insecure=1 \
pcmk_host_map="cmpcprmq90:CMP_FASTPLUSP_MQ_Svr1;cmpcprmq94:CMP_FASTPLUSP_MQ_Svr2" \
op monitor interval=60s


vmfence ‚Üí fencing resource ‡§ï‡§æ ‡§®‡§æ‡§Æ

fence_vmware_rest ‚Üí VMware REST API fencing agent

ipaddr=10.191.22.53 ‚Üí vCenter ‡§Ø‡§æ ESXi host ‡§ï‡§æ IP

username ‡§î‡§∞ passwd ‚Üí VMware ‡§ï‡•á credentials

ssl_insecure=1 ‚Üí SSL certificate verification skip (‡§Ö‡§ó‡§∞ cert trusted ‡§®‡§π‡•Ä‡§Ç)

pcmk_host_map ‚Üí cluster nodes ‡§î‡§∞ VMware VM names ‡§ï‡•Ä mapping

op monitor interval=60s ‚Üí 60 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç fencing agent health check












Step 9 ‚Äî Enable fencing and failover properties:

sudo pcs property set stonith-enabled=true
sudo pcs property set startup-fencing=true
sudo pcs property set concurrent-fencing=true
sudo pcs property set cluster-recheck-interval=1min

Step 10 ‚Äî Create Virtual IP resource:
sudo pcs resource create VirtualIP IPaddr2 ip=10.191.145.144 cidr_netmask=21 nic=ens192 op monitor interval=20s

Step 11 ‚Äî Create MQ service resource (example):
sudo pcs resource create MQService systemd:mqserver op monitor interval=15s

Step 12 ‚Äî Setup resource constraints (ordering and colocation):
sudo pcs constraint order VirtualIP then MQService
sudo pcs constraint colocation add MQService with VirtualIP INFINITY

Step 13 ‚Äî Verify cluster status and fencing:
pcs status --full
pcs resource show
pcs stonith show
pcs quorum status

Step 14 ‚Äî Test failover:

Move VIP to other node:

sudo pcs resource move VirtualIP cmpcprmq94


Shutdown node and check failover:

sudo ssh cmpcprmq90 sudo shutdown -r now


Verify VIP and MQService move to other node.

Step 15 ‚Äî Check logs if any issues:
journalctl -u pacemaker -f
journalctl -u corosync -f
journalctl -u pcsd -f

üîë Important Tips:

VMware fencing requires vCenter user with correct permissions for power on/off/reset VM

Firewall must allow necessary ports: UDP 5404-5405, TCP 2224

hacluster password must be same on all nodes

Node hostnames must match cluster config

Corosync config (if customized) should have proper node IPs and nodeids

Use secure passwords and SSL if possible (ssl_insecure=1 is for testing)

‡§Ö‡§ó‡§∞ ‡§Ü‡§™ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã fencing ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ basic cluster setup ‡§Ø‡§æ IPMI fencing ‡§ï‡§æ ‡§≠‡•Ä A-Z ‡§¶‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§

‡§¨‡§§‡§æ‡§á‡§è ‡§ï‡•ç‡§Ø‡§æ ‡§ö‡§æ‡§π‡§ø‡§è?
